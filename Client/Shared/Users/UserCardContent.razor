@inject HttpClient http
@inject NavigationManager NavigationManager

<div class="user-card-content" contenteditable="false"
     @onclick="OnClick">
            <div class="symbol">
                <div class="twa-5x @User.Avatar"></div>
            </div>
                    
            <p class="name">@User.Name</p>

    <div class="user-card-details">
        <div class="progress-xp">
            <progress class="progress is-small @XpProgressBarColor" value="@User.XP" max="@User.Goal"></progress>
            <p class="subtitle">@User.XP/@User.Goal</p>
        </div>
        
    </div>
    <div class="user-card-history">
        @if(IsLoadingCompletedAssignmentsToday)
        {
            <progress class="progress is-small is-warning" max="100"></progress>
        }
        
        @foreach (var completedAssignment in Assignments.OrderBy(a => a.Assignment.Timestamp))
        {
            <div class="symbols" @onclick="@(async _ => await UndoCompletedAssignmentCallback(User.RowKey, completedAssignment.CompletedAssignmentRowKey))" @onclick:stopPropagation>
                <div class="emoji">
                    <div class="twa-2x @completedAssignment.Assignment.Emoji"></div>
                </div>
                <div class="emoji-modifier">
                    <div class="twa @completedAssignment.Assignment.EmojiModifier"></div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public User User { get; set; }
    [Parameter] public EventCallback OnClick { get; set; }
    private string XpProgressBarColor 
    {
        get
        {
            if(User.XP >= User.Goal)
            {
                return "is-warning";
            } else
            {
                return "is-primary";
            }
        }
    }
    private List<GroupedAssignments> Assignments { get; set; } = new List<GroupedAssignments>();
    private bool IsLoadingCompletedAssignmentsToday { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        IsLoadingCompletedAssignmentsToday = true;
        var completedAssignmentsToday = await http.GetFromJsonAsync<List<CompletedAssignment>>($"api/users/{User.RowKey}/completedassignmentstoday");

        foreach (var completedAssignmentTodayGroup in completedAssignmentsToday.GroupBy(c => c.AssignmentRowKey))
        {
            Assignments.Add(new GroupedAssignments
                {
                    Assignment = completedAssignmentTodayGroup.First().Assignment,
                    TimeStamp = completedAssignmentTodayGroup.First().TimeCompleted,
                    CompletedAssignmentRowKey = completedAssignmentTodayGroup.First().RowKey,
                    Completed = true,
                    Count = completedAssignmentTodayGroup.Count()
                });
        }

        StateHasChanged();
        IsLoadingCompletedAssignmentsToday = false;
    }

    private async Task UndoCompletedAssignmentCallback(string userId, string completedAssignmentRowKey)
    {
        var deleteCompletedAssignmentResult = await http.DeleteAsync($"api/users/{userId}/completedassignments/{completedAssignmentRowKey}");
        await OnInitializedAsync();
        NavigationManager.NavigateTo("/users", true);
    }

    private class GroupedAssignments
    {
        public Assignment Assignment { get; set; }
        public string CompletedAssignmentRowKey { get; set; }
        public DateTime TimeStamp { get; set; }
        public bool Completed { get; set; }
        public int Count { get; set; }
    }
}